# VM Module

This module provides a reusable, flexible way to deploy virtual machines on Proxmox VE.

## Overview

The VM module handles:
- VM creation with customizable CPU, memory, and disk configuration
- Cloud-init provisioning with user data and metadata
- Support for multiple additional disks
- Network configuration
- Tag management
- Lifecycle management to prevent unnecessary rebuilds

## Usage

### Basic Example

```hcl
module "vm_example" {
  source = "./modules/vm"

  proxmox_node = "pve"
  template_tag = "template"

  vm_config = {
    hostname = "example"
    domain   = "local"
  }
}
```

### Advanced Example

```hcl
module "vm_advanced" {
  source = "./modules/vm"

  proxmox_node = "pve"
  template_tag = "template"

  vm_config = {
    hostname = "webserver"
    domain   = "example.com"
    on_boot  = true
    tags     = ["web", "frontend", "production"]

    cpu = {
      type    = "x86-64-v2-AES"
      cores   = 8
      sockets = 2
    }

    memory = 8192

    disk = {
      storage = "local-lvm"
      size    = 50
    }

    additional_disks = [
      {
        storage = "local-lvm"
        size    = 100
      },
      {
        storage = "local-lvm"
        size    = 50
      }
    ]

    network = {
      bridge = "vmbr0"
      model  = "virtio"
    }

    cloud_init = {
      enabled = true
      user    = "sysadmin"
    }
  }
}
```

## Input Variables

### Required Variables

- **`vm_config`** (object): Complete VM configuration with nested attributes
- **`proxmox_node`** (string): Target Proxmox node name

### Optional Variables

- **`template_tag`** (string, default: `"template"`): Tag to identify source template
- **`template_name_filter`** (string, default: `""`): Optional regex filter for template name

## VM Configuration (vm_config)

### Top-level Attributes

| Attribute | Type | Default | Description |
|-----------|------|---------|-------------|
| `hostname` | string | required | VM hostname |
| `domain` | string | `""` | Domain name (FQDN if combined with hostname) |
| `on_boot` | bool | `true` | Auto-start VM on Proxmox boot |
| `tags` | list(string) | `[]` | Proxmox tags for VM classification |

### CPU Configuration

```hcl
cpu = {
  type    = "x86-64-v2-AES"  # CPU type (default: x86-64-v2-AES)
  cores   = 2                 # CPU cores (default: 2)
  sockets = 1                 # CPU sockets (default: 1)
}
```

### Memory Configuration

```hcl
memory = 2048  # Memory in MB (default: 2048)
```

### Disk Configuration

```hcl
disk = {
  storage = "local-lvm"  # Storage datastore (default: local-lvm)
  size    = 10           # Disk size in GB (default: 10)
}

# Additional disks
additional_disks = [
  {
    storage = "local-lvm"
    size    = 50
  },
  {
    storage = "local-lvm"
    size    = 100
  }
]
```

### Network Configuration

```hcl
network = {
  bridge = "vmbr0"      # Network bridge (default: vmbr0)
  model  = "virtio"     # NIC model (default: virtio)
}
```

### Cloud-init Configuration

```hcl
cloud_init = {
  enabled = true          # Enable cloud-init (default: true)
  user    = "sysadmin"    # Default user (default: sysadmin)
}
```

## Outputs

The module exports the following outputs:

```hcl
vm_id              # VM ID in Proxmox
vm_name            # Full VM name (hostname.domain or hostname)
vm_node            # Proxmox node name
vm_hostname        # VM hostname
vm_domain          # VM domain
vm_fqdn            # Fully qualified domain name
vm_cpu_cores       # Number of CPU cores
vm_memory_mb       # Memory in MB
vm_disk_size_gb    # Primary disk size in GB
vm_tags            # VM tags
```

## Cloud-init Integration

### User Data

The module provides cloud-init user data template that includes:
- Hostname configuration
- FQDN setup
- User account creation with sudo privileges
- Package updates and upgrades
- Installation of common packages (qemu-guest-agent, curl, wget, vim, etc.)
- QEMU guest agent startup

### Metadata

Instance ID and local hostname are automatically configured.

### Customization

To customize cloud-init:

1. **Modify templates globally**: Edit `modules/vm/templates/user_data.yaml` and `meta_data.yaml`
2. **Use module locals**: Adjust template variables in module calls

## Validation

The module includes input validation for:
- CPU cores > 0
- Memory > 0
- Disk size > 0

## Lifecycle Management

The module ignores changes to `network_device` to prevent unnecessary VM rebuilds when MAC addresses are regenerated by Proxmox.

## Best Practices

1. **Use descriptive hostnames**: Makes VM identification easier
2. **Tag appropriately**: Use tags for environment, service, and role classification
3. **Right-size resources**: Configure appropriate CPU/memory for workload
4. **Plan disk space**: Account for growth and additional storage needs
5. **Document changes**: Update main.tf with comments explaining each VM's purpose

## Examples

### Web Server

```hcl
module "vm_web" {
  source = "./modules/vm"

  proxmox_node = var.proxmox_node
  template_tag = var.template_tag

  vm_config = {
    hostname = "web-01"
    domain   = var.domain
    tags     = ["web", "frontend"]
    cpu = {
      cores = 4
    }
    memory = 4096
    disk = {
      size = 20
    }
  }
}
```

### Database Server

```hcl
module "vm_db" {
  source = "./modules/vm"

  proxmox_node = var.proxmox_node
  template_tag = var.template_tag

  vm_config = {
    hostname = "db-01"
    domain   = var.domain
    tags     = ["database", "backend"]
    cpu = {
      cores   = 8
      sockets = 2
    }
    memory = 16384
    disk = {
      size = 50
    }
    additional_disks = [
      {
        storage = "local-lvm"
        size    = 200
      }
    ]
  }
}
```

### Development VM

```hcl
module "vm_dev" {
  source = "./modules/vm"

  proxmox_node = var.proxmox_node
  template_tag = var.template_tag

  vm_config = {
    hostname = "dev"
    domain   = var.domain
    on_boot  = false
    tags     = ["development"]
    cpu = {
      cores = 2
    }
    memory = 2048
    disk = {
      size = 10
    }
  }
}
```

## Troubleshooting

### VM fails to boot
- Verify template exists and has correct tag
- Check Proxmox node connectivity
- Ensure sufficient storage space

### Cloud-init not running
- Verify cloud-init is enabled in vm_config
- Check cloud-init logs in VM: `cloud-init status`

### Network connectivity issues
- Verify bridge exists: `qm config <vmid>` on Proxmox node
- Check network model compatibility with OS
- Verify DHCP or static IP configuration

## Related Documentation

- [Proxmox Provider](https://github.com/bpg/terraform-provider-proxmox)
- [Cloud-init Documentation](https://cloud-init.io/)
- [Terraform Modules Best Practices](https://www.terraform.io/docs/language/modules)
